@echo off
chcp 65001 > nul
cls

set "ROOT_DIR=D:\FaceFusion"
set "VENV_DIR=%ROOT_DIR%\venv"
set "PYTHON_PATH=%VENV_DIR%\Scripts\python.exe"
set "LAUNCHER_LOG=%ROOT_DIR%\launcher.log"

::=====================================
::    1. Python & Git Installation
::=====================================
echo [â³] ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Python Ñ‚Ð° Git...
where python > nul 2>&1 || (echo [âŒ] Python Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾. Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ Python Ð²Ñ€ÑƒÑ‡Ð½Ñƒ Ñ– Ð´Ð¾Ð´Ð°Ð¹ Ð´Ð¾ PATH. && pause && exit /b)
where git > nul 2>&1 || (echo [âŒ] Git Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾. Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ Git Ð²Ñ€ÑƒÑ‡Ð½Ñƒ Ñ– Ð´Ð¾Ð´Ð°Ð¹ Ð´Ð¾ PATH. && pause && exit /b)
echo [âœ”] Python Ñ‚Ð° Git Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾

::=====================================
::    2. Ð’Ñ–Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ðµ ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ðµ
::=====================================
echo [âš™] Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð²Ñ–Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ð°...
if not exist "%VENV_DIR%" (
    python -m venv "%VENV_DIR%"
)

call "%VENV_DIR%\Scripts\activate.bat"
echo [âœ”] Ð’Ñ–Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ðµ ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð¾Ð²Ð°Ð½Ð¾

::=====================================
::    3. ÐšÐ»Ð¾Ð½ÑƒÐ²Ð°Ð½Ð½Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ñ–ÑŽ
::=====================================
if not exist "%ROOT_DIR%\.git" (
    echo [â¬‡ï¸] ÐšÐ»Ð¾Ð½ÑƒÐ²Ð°Ð½Ð½Ñ FaceFusion...
    git clone https://github.com/facefusion/facefusion.git "%ROOT_DIR%"
)
cd /d "%ROOT_DIR%"

::=====================================
::    4. Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚ÐµÐ¹
::=====================================
echo [ðŸ“¦] Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚ÐµÐ¹...
"%PYTHON_PATH%" -m pip install --upgrade pip
"%PYTHON_PATH%" -m pip install -r requirements.txt

::=====================================
::    5. CUDA PATH Setup & ONNX Fix
::=====================================
echo.
echo =====================================
echo     [ðŸ”§] CUDA PATH Setup & Check
echo =====================================

set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.8"
setx PATH "%PATH%;%CUDA_PATH%\bin;%CUDA_PATH%\libnvvp"
echo [âœ”] CUDA ÑˆÐ»ÑÑ…Ð¸ Ð´Ð¾Ð´Ð°Ð½Ð¾ Ð´Ð¾ PATH

set "CUDART_DLL=%CUDA_PATH%\bin\cudart64_120.dll"
set "ONNX_CAPI_PATH=%VENV_DIR%\Lib\site-packages\onnxruntime\capi"

if not exist "%CUDART_DLL%" (
    echo [âŒ] cudart64_120.dll Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² %CUDA_PATH%\bin
    echo     ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ Ð²ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ CUDA Toolkit 12.8
    pause
) else (
    echo [âœ”] cudart64_120.dll Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
    echo [ðŸ“¦] ÐšÐ¾Ð¿Ñ–ÑŽÑ”Ð¼Ð¾ cudart64_120.dll Ð´Ð¾ ONNXRuntime...
    copy "%CUDART_DLL%" "%ONNX_CAPI_PATH%" > nul
    echo [âœ”] Ð“Ð¾Ñ‚Ð¾Ð²Ð¾
)

if not exist "%ONNX_CAPI_PATH%\onnxruntime_providers_cuda.dll" (
    echo [âŒ] onnxruntime_providers_cuda.dll Ð²Ñ–Ð´ÑÑƒÑ‚Ð½Ñ–Ð¹!
    echo     Ð’Ð¸ÐºÐ¾Ð½Ð°Ð¹: pip install onnxruntime-gpu==1.17.1
    "%PYTHON_PATH%" -m pip uninstall onnxruntime onnxruntime-gpu -y
    "%PYTHON_PATH%" -m pip install onnxruntime-gpu==1.17.1
) else (
    echo [âœ”] onnxruntime_providers_cuda.dll Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
)

echo [âœ…] ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° CUDA + ONNX Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°

::=====================================
::    6. Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÑÑ€Ð»Ð¸ÐºÐ° (Ð¾Ð¿Ñ†Ñ–Ð¹Ð½Ð¾)
::=====================================
REM Ð¢ÑƒÑ‚ Ð¼Ð¾Ð¶Ð½Ð° Ð²ÑÑ‚Ð°Ð²Ð¸Ñ‚Ð¸ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÑÑ€Ð»Ð¸ÐºÐ°, ÑÐºÑ‰Ð¾ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾

::=====================================
::    7. Ð›Ð°ÑƒÐ½Ñ‡ÐµÑ€ Ñ€ÐµÐ¶Ð¸Ð¼Ñ–Ð² Ð·Ð°Ð¿ÑƒÑÐºÑƒ
::=====================================
:launcher
cls
echo =====================================
echo      FaceFusion Launcher
echo =====================================
echo.
echo Select launch mode:
echo.
echo 1. Normal mode (with GUI)
echo 2. GPU mode (CUDA)
echo 3. Full mode (GPU + all providers)
echo.
set /p mode="Select mode (1-3): "

if "%mode%"=="1" goto normal
if "%mode%"=="2" goto cuda
if "%mode%"=="3" goto full
echo [!] ÐÐµÐ²Ñ–Ñ€Ð½Ð¸Ð¹ Ð²Ð¸Ð±Ñ–Ñ€.
pause
goto launcher

:normal
echo Ð—Ð°Ð¿ÑƒÑÐº FaceFusion Ñƒ Ð·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð¾Ð¼Ñƒ Ñ€ÐµÐ¶Ð¸Ð¼Ñ–...
"%PYTHON_PATH%" run.py >> "%LAUNCHER_LOG%" 2>&1
exit /b

:cuda
echo Ð—Ð°Ð¿ÑƒÑÐº FaceFusion Ð· CUDA...
"%PYTHON_PATH%" run.py --execution-provider cuda >> "%LAUNCHER_LOG%" 2>&1
exit /b

:full
echo Ð—Ð°Ð¿ÑƒÑÐº FaceFusion Ñƒ Ð¿Ð¾Ð²Ð½Ð¾Ð¼Ñƒ Ñ€ÐµÐ¶Ð¸Ð¼Ñ–...
"%PYTHON_PATH%" run.py --execution-provider cuda --all-providers >> "%LAUNCHER_LOG%" 2>&1
exit /b
